# 售票机 - 工作流程与逻辑说明文档

本文档概述了**主控板**（Python/MicroPython）与 **LED 屏幕控制板**（Arduino/C++）之间的运行逻辑和通信流程。

## 系统概览

系统由两个主要控制器组成，通过 GPIO 信号进行通信：
1.  **主控板 (Main Control Board)**：负责处理用户按键、语音反馈（DFPlayer）以及热敏打印机。
2.  **LED 屏幕板 (LED Screen Board)**：控制 HUB75 显示屏并管理 UI 状态机。

## 硬件接口与接线

### 通信引脚
两块控制板通过 4 根 GPIO 线连接（相对于主控板，2 根输出，2 根输入）。

| 信号方向 | 主控引脚 (ESP32/Py) | LED 引脚 (ESP32/C++) | 逻辑功能 (代码中) | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **主控 -> LED** | `12` (LED_TO_PIN_1) | `34` (LED_IN_PIN_1) | 按键 1 信号 | *见下方交换说明* |
| **主控 -> LED** | `13` (LED_TO_PIN_2) | `35` (LED_IN_PIN_2) | 按键 2 信号 | *见下方交换说明* |
| **LED -> 主控** | `21` (LED_FROM_PIN_1)| `21` (LED_OUT_PIN_1)| 同步脉冲 / 反馈 | 用于数据同步 |
| **LED -> 主控** | `22` (LED_FROM_PIN_2)| `22` (LED_OUT_PIN_2)| 动作触发 | 触发打印任务 |

> **⚠️ 接线/逻辑差异说明**：
> 在 `New_Main.py` 中，按键 1 标记为“下一个”并触发引脚 12；按键 2 为“确认”并触发引脚 13。
> 在 `New_LED.ino` 中，引脚 34（连至 12）触发 `CONFIRM_COMMAND`；引脚 35（连至 13）触发 `CHANGE_COMMAND`。
> **结果**：根据当前代码注释，按键功能实际上是反向的，或者接线设计为交叉触发（下一个按键触发确认动作）。

### 外设连接
*   **按键 (主控板)**
    *   按键 1：引脚 4 (下一个/交互)
    *   按键 2：引脚 5 (确认/交互)
    *   按键 3：引脚 14 (直接抽奖) - **新增**
*   **音频 (主控板)**
    *   DFPlayer Mini UART: TX=26, RX=27
*   **打印机 (主控板)**
    *   热敏打印机 UART: TX=16, RX=17 (波特率 115200)

---

## 1. 主控板逻辑 (`New_Main.py`)

主控板充当物理交互层（按键、声音、打印），并依赖 LED 板进行状态管理。

### 主循环
脚本运行无限循环来检查输入状态：

1.  **按键处理**：
    *   **按下按键 1**：
        *   向 `LED_TO_PIN_1` 发送高电平脉冲。
        *   播放音频轨道 1。
        *   设置防抖/阻塞计时器（约 300ms）。
    *   **按下按键 2**：
        *   向 `LED_TO_PIN_2` 发送高电平脉冲。
        *   播放音频轨道 2。
        *   设置防抖/阻塞计时器。
    *   **按下按键 3 (直接抽奖)**：
        *   **同时**向 `LED_TO_PIN_1` 和 `LED_TO_PIN_2` 发送高电平脉冲。
        *   播放音频轨道 1（点击音效）。
        *   设置防抖/阻塞计时器。

2.  **LED 反馈处理（来自 LED 板的输入）**：
    *   **引脚 22 (触发线) 高电平**：
        *   **动作**：`确认 (CONFIRM)` / `打印 (PRINT)`。
        *   播放音频轨道 4（成功音效）。
        *   调用 `print_ticket(cur_pick_param)`：打印当前选定站点 ID 的车票。
        *   重置 `cur_pick_param` 为 0。
    *   **引脚 21 (同步线) 高电平**：
        *   **动作**：`通过 (PASS)` / `自增 (INCREMENT)`。
        *   播放音频轨道 3（滴答音）。
        *   将 `cur_pick_param` 加 1（用于本地同步 LED 板选中的站点 ID）。

---

## 2. LED 屏幕板逻辑 (`New_LED.ino`)

LED 板负责显示内容并管理应用状态机。

### 状态说明
*   **INIT (0) 初始态**：主菜单。选项：“查看 (Check)” 或 “来一发 (Pick/抽票)”。
*   **CHECK (1) 查看态**：浏览模式。循环显示站点详细信息。
*   **PICK (2) 抽票态**：抽奖模式。随机滚动选择一个站点。

### 输入处理 (`Determine_Input`)
*   **引脚 34 & 35 同时高电平**：解释为 `DIRECT_PICK_COMMAND`（直接抽奖）。**优先级最高**。
*   **引脚 34 高电平**：解释为 `CONFIRM_COMMAND`（确认/进入）。
*   **引脚 35 高电平**：解释为 `CHANGE_COMMAND`（切换/移动）。

### 状态逻辑

#### 全局指令
*   **输入 `DIRECT_PICK`**：无论当前处于哪个状态，立即重置并切换至 **PICK (抽票)** 状态，开始随机滚动。

#### A. INIT 界面
*   **输入 `CHANGE`**：在“查看”和“来一发”图标之间切换选择。
*   **输入 `CONFIRM`**：
    *   若选中“查看”：切换至 **CHECK** 状态。
    *   若选中“来一发”：切换至 **PICK** 状态，计算随机滚动步数 (`rounds_until_finishing_pick`)。

#### B. CHECK 界面
*   **输入 `CHANGE`**：增加 `cur_check_param`。显示下一个站点的详细信息。
*   **输入 `CONFIRM`**：退出并返回 **INIT** 状态。

#### C. PICK 界面 (自动动画)
*   在滚动阶段，系统忽略按键输入。
*   **动画循环**：
    *   递减 `rounds_until_finishing_pick`。
    *   增加 `cur_pick_param`（站点 ID 循环滚动）。
    *   更新屏幕显示。
*   **滚动完成 (步数为 0)**：
    1.  **数据同步阶段**：
        *   调用 `send_confirm_message()`。
        *   向 `LED_OUT_PIN_1` (引脚 21) 发送 **N 次** 脉冲（N = 最终选中的站点 ID）。
        *   *效果*：主控板本地计数器会增加 N 次，从而与 LED 板的结果对齐。
    2.  **触发阶段**：
        *   向 `LED_OUT_PIN_2` (引脚 22) 发送 **一次** 高电平脉冲。
        *   *效果*：主控板收到信号，开始打印车票。
    3.  **结果展示**：
        *   显示“已选中”动画。
        *   等待 15 秒。
        *   重置回 **INIT** 状态。

---

## 交互流程总结

1.  **用户** 按下主控板上的物理按键。
2.  **主控板** 发出蜂鸣并将信号转发给 **LED 板**。
3.  **LED 板** 根据信号更新图形界面（例如移动光标）。
4.  *(抽票模式下)* **LED 板** 运行内部随机抽奖逻辑。
5.  **LED 板** 通过同步线向 **主控板** 发送脉冲，同步最终结果（站点 ID）。
6.  **LED 板** 向 **主控板** 发送最终触发信号。
7.  **主控板** 通过热敏打印机打印出对应车票。